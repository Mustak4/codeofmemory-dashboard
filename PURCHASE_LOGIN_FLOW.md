# Purchase to Login Flow

This document explains how users who purchase on `codeofmemory.com` are automatically logged into `login.codeofmemory.com`.

## Flow Overview

1. **User purchases on codeofmemory.com**
   - User completes checkout/payment
   - Main site generates a purchase token (unique, one-time use)
   - Main site redirects user to login subdomain

2. **Redirect to login.codeofmemory.com**
   - URL format: `https://login.codeofmemory.com/signin?purchase_token=TOKEN&email=user@example.com`
   - The `purchase_token` is a secure, time-limited token generated by the main site
   - The `email` parameter is optional but recommended for better UX

3. **Automatic verification and login**
   - Dashboard app detects `purchase_token` in URL
   - Verifies token with backend (or payment processor)
   - Auto-creates user account if needed
   - Auto-logs in the user
   - Redirects to `/onboarding` to set up their memorial

## Implementation Details

### Main Site (codeofmemory.com) Requirements

After successful payment, redirect the user with:

```javascript
// Example redirect after successful Stripe payment
const purchaseToken = generatePurchaseToken(orderId, customerEmail);
const loginUrl = `https://login.codeofmemory.com/signin?purchase_token=${purchaseToken}&email=${encodeURIComponent(customerEmail)}`;
window.location.href = loginUrl;
```

**Token Generation Requirements:**
- Unique per purchase
- Time-limited (e.g., expires in 1 hour)
- One-time use only
- Signed/encrypted to prevent tampering
- Contains order ID and customer email

### Dashboard App (login.codeofmemory.com) Implementation

The dashboard app automatically handles purchase tokens:

1. **Signin Page** (`src/pages/Signin.tsx`)
   - Detects `purchase_token` in URL parameters
   - Shows loading state: "Verifying your purchase"
   - Calls `verifyPurchaseAndLogin()` from AuthContext

2. **AuthContext** (`src/contexts/AuthContext.tsx`)
   - `verifyPurchaseAndLogin()` method verifies the token
   - Creates user account if needed
   - Stores purchase order ID for reference
   - Auto-logs in the user

3. **Purchase Verification** (`src/utils/purchaseVerification.ts`)
   - `verifyPurchaseToken()` function
   - Currently uses mock implementation
   - **TODO**: Replace with actual API call to verify token

### Production Setup

To make this work in production:

1. **Update `verifyPurchaseToken()` in `src/utils/purchaseVerification.ts`**:
   ```typescript
   export async function verifyPurchaseToken(
     token: string,
     email?: string
   ): Promise<PurchaseVerificationResult> {
     // Call your backend API
     const response = await fetch(
       `${API_BASE_URL}/api/verify-purchase?token=${token}&email=${email}`,
       { method: 'POST' }
     );
     
     if (!response.ok) {
       return {
         success: false,
         email: email || "",
         error: "Token verification failed"
       };
     }
     
     const data = await response.json();
     return {
       success: true,
       email: data.email,
       orderId: data.orderId
     };
   }
   ```

2. **Backend API Endpoint** (`/api/verify-purchase`):
   - Verify token signature/expiration
   - Check token hasn't been used
   - Verify purchase was successful
   - Return customer email and order details
   - Mark token as used (prevent replay attacks)

3. **Token Security**:
   - Use JWT or similar signed tokens
   - Include expiration timestamp
   - Sign with secret key shared between main site and dashboard
   - Validate signature on dashboard side

## Testing

To test the flow locally:

1. Navigate to: `http://localhost:5173/signin?purchase_token=test-token-12345&email=test@example.com`
2. The app will automatically verify and log in
3. You'll be redirected to `/onboarding`

## Error Handling

If token verification fails:
- User sees error toast notification
- User can still manually sign in with their email
- Support contact information should be provided

## Security Considerations

- Tokens should expire quickly (1 hour max)
- Tokens should be single-use only
- Validate token signature server-side
- Rate limit verification attempts
- Log all verification attempts for security monitoring

